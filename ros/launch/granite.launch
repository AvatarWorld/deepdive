<launch>

  <!-- Arguments to the deepdive framework -->
  <arg name="target" default="" />
  <arg name="replay" default="" />
  <arg name="record" default="" />
  <arg name="rviz" default="true" />
  <arg name="output" default="screen" />
  <arg name="offline" default="false" />
  <arg name="speed" default="1" />

  <!-- SUPPORT NODES -->

  <!-- Visualization, if needed -->
  <node if="$(arg rviz)" name="deepdive_rviz" pkg="rviz" type="rviz"
        args="-d $(find deepdive_ros)/rviz/granite.rviz"/>

  <!-- Data recorder, if needed -->
  <node if="$(eval arg('record') != '')" name="deepdive_recorder" output="$(arg output)"
        pkg="rosbag" type="record"
        args="-O $(arg record) /trackers /lighthouses /imu /light /button /tf"/>

  <!-- Data replay, if needed -->
  <node unless="$(eval arg('replay') != '')" name="deepdive_bridge"
        pkg="deepdive_ros" type="deepdive_bridge"/>

  <!-- CORE NODES -->

  <!-- Replay if needed, and speed up in an offline experiment by 10x -->
  <node if="$(eval arg('replay') != '')" name="deepdive_player" output="log"
        pkg="rosbag" type="play" args="--clock -d 1 -r $(arg speed) $(arg replay)">
    <remap unless="$(arg offline)" from="/tf" to="/tf/dev/null"/>
  </node>

  <!-- Frame inversion for a Z-down view of the world -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="rviz_bc"
    args="0 0 0 1 0 0 0 world rviz" />

  <!-- One filter for each of the two trackers -->
  <node name="deepdive_tracker_port" output="$(arg output)"
        pkg="deepdive_ros" type="deepdive_tracker">
    <rosparam command="load" file="$(find deepdive_ros)/cfg/granite-tracker-port.yaml" />
  </node>
  <node name="deepdive_tracker_stbd" output="$(arg output)"
        pkg="deepdive_ros" type="deepdive_tracker">
    <rosparam command="load" file="$(find deepdive_ros)/cfg/granite-tracker-stbd.yaml" />
  </node>

  <!-- One calibration algorithm-->
  <node name="deepdive_calibration" output="$(arg output)"
        pkg="deepdive_ros" type="deepdive_calibration">
    <rosparam command="load" file="$(find deepdive_ros)/cfg/granite-calibration.yaml" />
    <param name="offline" type="bool" value="$(arg offline)" />
  </node>

</launch>
